name: CI - Tests Automatizados

on:
  push:
    branches: [ "ci" ]
  pull_request:
    branches: [ "ci" ]

jobs:
  test-api:
    runs-on: ubuntu-latest

    # SERVICIOS: Esto levanta un Postgres temporal solo para el test
    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_USER: aida_admin
          POSTGRES_PASSWORD: pruebaci123
          POSTGRES_DB: aida_db
        ports:
          - 5432:5432
        # Health check para esperar a que la DB estÃ© lista antes de seguir
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
    - name: Descargar el repositorio
      uses: actions/checkout@v4

    - name: Instalar Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '22'
        cache: 'npm'

    - name: Instalar dependencias
      run: npm ci

    - name: Inicializar base de Datos
      run: |
        psql -h localhost -U aida_admin -d aida_db \
          -f recursos/archivos-sql/creacion-esquema.sql \
          -f recursos/archivos-sql/trigger-titulo.sql \
          -f recursos/archivos-sql/carga-datos-prueba.sql
      env:
        PGPASSWORD: pruebaci123

    - name: Ejecutar Tests
      run: npm run test
      env:
        # Las variables de entorno necesarias para los tests
        DB_HOST: localhost
        DB_USER: aida_admin
        DB_PASSWORD: pruebaci123
        DB_NAME: aida_db
        DB_PORT: 5432
        IS_DEVELOPMENT: true

