<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Gestión de Usuarios Simple</title>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Roboto:wght@400;500&family=Merriweather:wght@700&display=swap');

    body {
      font-family: 'Roboto', sans-serif;
      margin: 0;
      padding: 30px 20px;
      background-color: #f4f6f8;
      color: #333;
    }

    h2 {
      color: #2E7D32;
      border-bottom: 2px solid #2E7D32;
      padding-bottom: 10px;
      margin-bottom: 25px;
      font-family: 'Merriweather', serif;
    }

    h3 {
      margin-top: 0;
      color: #2E7D32;
      font-family: 'Merriweather', serif;
    }

    .table-wrapper {
      background: white;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.08);
      overflow: hidden;
      margin-bottom: 20px;
    }

    table {
      border-collapse: collapse;
      width: 100%;
    }

    th, td {
      padding: 12px 16px;
      text-align: left;
      border-bottom: 1px solid #eee;
    }

    th {
      background-color: #4CAF50;
      color: white;
      font-weight: 500;
      text-transform: uppercase;
      font-size: 0.85em;
    }

    tr:nth-child(even) { background-color: #fcfcfc; }
    tr:hover { background-color: #f1f8e9; }

    input {
      width: 100%;
      box-sizing: border-box;
      padding: 8px;
      border: 1px solid #ddd;
      border-radius: 4px;
    }

    /* campos no editables en modo edición */
    input[disabled] {
      background-color: #eee;
      color: #777;
    }

    input.editable {
      background-color: #fff;
      color: #333;
    }

    button {
      padding: 8px 14px;
      border-radius: 4px;
      border: none;
      cursor: pointer;
      font-size: 0.9em;
      transition: background 0.2s, box-shadow 0.2s;
    }

    button:disabled {
      opacity: 0.6;
      cursor: default;
    }

    .btn-primary {
      background-color: #66BB6A;
      color: white;
      box-shadow: 0 2px 4px rgba(0,0,0,0.15);
    }

    .btn-primary:hover {
      background-color: #388E3C;
    }

    .btn-secondary {
      background-color: #EEEEEE;
      color: #555;
    }

    .btn-secondary:hover {
      background-color: #E0E0E0;
    }

    /* acciones de la tabla: Editar / Eliminar */
    td.acciones button {
      margin: 0 4px;
      min-width: 80px;
    }

    td.acciones button:first-child {
      /* Editar */
      background-color: #FFB74D;
      color: white;
    }

    td.acciones button:first-child:hover {
      background-color: #F57C00;
    }

    td.acciones button:last-child {
      /* Eliminar */
      background-color: #E57373;
      color: white;
    }

    td.acciones button:last-child:hover {
      background-color: #D32F2F;
    }

    /* barra de acciones encima del form */
    .actions-bar {
      margin-bottom: 15px;
    }

    /* Formulario de alta como card */
    #form-alta {
      margin-top: 10px;
      padding: 20px;
      background: white;
      max-width: 420px;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.08);
      display: none;
    }

    #form-alta div {
      margin-bottom: 12px;
    }

    #form-alta label {
      font-weight: 500;
      margin-bottom: 4px;
      display: block;
      font-size: 0.9em;
      color: #555;
    }

    #form-alta-buttons {
      display: flex;
      gap: 10px;
      margin-top: 10px;
    }
  </style>
</head>

<body onload="cargarUsuarios()">

  <h2>Gestión de Usuarios</h2>

  <div class="table-wrapper">
    <table id="tabla-usuarios">
      <thead>
        <tr>
          <th>id_usuario</th>
          <th>username</th>
          <th>Nombre</th>
          <th>Apellido</th>
          <th>Email</th>
          <th>Acción</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <div class="actions-bar">
    <button id="btn-toggle-form" class="btn-primary" onclick="toggleFormularioAlta()">
      Agregar usuario
    </button>
  </div>

  <div id="form-alta">
    <h3>Nuevo usuario</h3>

    <div>
      <label>Username</label>
      <input id="alta-username" />
    </div>

    <div>
      <label>Nombre</label>
      <input id="alta-nombre" />
    </div>

    <div>
      <label>Apellido</label>
      <input id="alta-apellido" />
    </div>

    <div>
      <label>Email</label>
      <input id="alta-email" />
    </div>

    <div>
      <label>Password</label>
      <input id="alta-password" type="password" />
    </div>

    <div id="form-alta-buttons">
      <button class="btn-primary" onclick="crearUsuario()">Crear</button>
      <button class="btn-secondary" onclick="toggleFormularioAlta()">Cancelar</button>
    </div>
  </div>

  <script>
    const API_USUARIOS_BASE = "/api/v0/usuarios";

    // =================================================================
    // FUNCIONES CRUD
    // =================================================================

    async function cargarUsuarios() {
      try {
        const res = await fetch(API_USUARIOS_BASE);
        if (!res.ok) throw new Error(`Error ${res.status} al cargar usuarios.`);

        const data = await res.json();
        const tbody = document.querySelector("#tabla-usuarios tbody");
        tbody.innerHTML = "";

        data.forEach(usuario => {
          const tr = document.createElement("tr");
          // Añadimos el ID como data-id para facilitar la selección
          tr.dataset.id = usuario.id_usuario;

          tr.innerHTML = `
            <td data-field="id_usuario" class="uneditable">${usuario.id_usuario}</td>
            <td data-field="username" class="uneditable">${usuario.username}</td>
            <td data-field="nombre_usuario" class="editable">${usuario.nombre_usuario ?? ''}</td>
            <td data-field="apellido" class="editable">${usuario.apellido ?? ''}</td>
            <td data-field="email" class="editable">${usuario.email ?? ''}</td>
            <td class="acciones">
              <button onclick="editarUsuario('${usuario.id_usuario}', this)">Editar</button>
              <button onclick="eliminarRegistro('${usuario.id_usuario}')">Eliminar</button>
            </td>
          `;
          tbody.appendChild(tr);
        });

      } catch (e) {
        console.error("Error al cargar:", e);
        alert("No se pudo cargar la lista de usuarios.");
      }
    }

    async function crearUsuario() {
      const body = {
        username: document.getElementById("alta-username").value,
        nombre_usuario: document.getElementById("alta-nombre").value,
        apellido: document.getElementById("alta-apellido").value,
        email: document.getElementById("alta-email").value,
        password: document.getElementById("alta-password").value
      };

      try {
        const res = await fetch(API_USUARIOS_BASE, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(body)
        });

        if (!res.ok) {
          const errorText = await res.text();
          throw new Error(`Error ${res.status}: ${errorText || res.statusText}`);
        }

        // Éxito: limpia y recarga
        document.getElementById("form-alta").querySelectorAll('input').forEach(input => input.value = '');
        toggleFormularioAlta();
        cargarUsuarios();

      } catch (error) {
        alert("Fallo al crear usuario: " + error.message);
        console.error("Error completo:", error);
      }
    }

    async function eliminarRegistro(idUsuario) {
      if (!confirm(`¿Eliminar usuario con ID ${idUsuario}?`)) return;

      try {
        const url = `${API_USUARIOS_BASE}/${idUsuario}`;
        const res = await fetch(url, { method: "DELETE" });

        if (!res.ok) {
          const errorText = await res.text();
          throw new Error(`Error ${res.status}: ${errorText || res.statusText}`);
        }

        cargarUsuarios();

      } catch (error) {
        alert("Fallo al eliminar: " + error.message);
        console.error("Error al eliminar:", error);
      }
    }

    // =================================================================
    // FUNCIONES DE EDICIÓN
    // =================================================================

    function editarUsuario(idUsuario, editButton) {
      const row = editButton.closest('tr');
      const editableFields = ['nombre_usuario', 'apellido', 'email'];

      // 1. Convertir celdas a inputs
      row.querySelectorAll('td').forEach(td => {
        const fieldName = td.dataset.field;

        if (editableFields.includes(fieldName)) {
          // Campos editables (Nombre, Apellido, Email)
          const currentValue = td.textContent;
          td.innerHTML = `<input type="text" value="${currentValue}" data-field="${fieldName}" class="editable">`;
        } else if (fieldName) {
          // Campos no editables (ID, Username) - Se simula la deshabilitación visual
          td.innerHTML = `<input type="text" value="${td.textContent}" disabled>`;
        }
      });

      // 2. Modificar botones
      const actionsCell = row.querySelector('.acciones');
      actionsCell.innerHTML = `
        <button class="btn-primary" onclick="guardarEdicion('${idUsuario}', this)">Guardar</button>
        <button class="btn-secondary" onclick="cargarUsuarios()">Deshacer</button>
      `;
    }

    async function guardarEdicion(idUsuario, saveButton) {
      const row = saveButton.closest('tr');
      const inputs = row.querySelectorAll('input.editable');

      const body = {};
      inputs.forEach(input => {
        // Recopila los datos de los inputs
        body[input.dataset.field] = input.value;
      });

      try {
        // Ruta: /api/v0/usuarios/:id_usuario
        const url = `${API_USUARIOS_BASE}/${idUsuario}`;
        const res = await fetch(url, {
          method: "PUT", // Usamos PUT para la actualización
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(body)
        });

        if (!res.ok) {
          const errorText = await res.text();
          throw new Error(`Error ${res.status}: ${errorText || res.statusText}`);
        }

        alert("Usuario actualizado con éxito.");
        cargarUsuarios(); // Recargar para mostrar los datos actualizados y el estado normal

      } catch (error) {
        alert("Fallo al guardar: " + error.message);
        console.error("Error al guardar:", error);
      }
    }

    // =================================================================
    // FUNCIÓN DE UI
    // =================================================================

    function toggleFormularioAlta() {
      const f = document.getElementById("form-alta");
      const btn = document.getElementById("btn-toggle-form");

      if (f.style.display === "none" || f.style.display === "") {
        f.style.display = "block";
        btn.textContent = "Ocultar formulario";
      } else {
        f.style.display = "none";
        btn.textContent = "Agregar usuario";
      }
    }
  </script>

</body>
</html>
