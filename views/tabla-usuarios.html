<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Gestión de Usuarios Simple</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 30px; background-color: #f9f9f9; }
    table { border-collapse: collapse; width: 100%; background: white; box-shadow: 0px 2px 6px rgba(0,0,0,0.1); }
    th, td { border: 1px solid #ddd; padding: 10px 12px; text-align: left; }
    th { background-color: #4CAF50; color: white; }
    tr:nth-child(even) { background-color: #f2f2f2; }
    tr:hover { background-color: #e1f5fe; }
    input {
      width: 100%;
      box-sizing: border-box;
      padding: 6px;
      /* Estilo para campos no editables */
      background-color: #eee;
      color: #777;
    }
    input.editable {
        background-color: white;
        color: #333;
    }
    button { padding: 6px 10px; margin: 3px; }

    #form-alta {
      margin-top: 20px;
      padding: 20px;
      background: white;
      width: 350px;
      border-radius: 6px;
      box-shadow: 0px 2px 6px rgba(0,0,0,0.1);
      display: none;
    }

    #form-alta div { margin-bottom: 12px; }
    #form-alta label { font-weight: bold; display: block; margin-bottom: 4px; }
  </style>
</head>

<body onload="cargarUsuarios()">

  <h2>Gestión de Usuarios</h2>

  <table id="tabla-usuarios">
    <thead>
      <tr>
        <th>id_usuario</th>
        <th>username</th>
        <th>Nombre</th>
        <th>Apellido</th>
        <th>Email</th>
        <th>Acción</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <button id="btn-toggle-form" onclick="toggleFormularioAlta()">Agregar usuario</button>

  <div id="form-alta">
    <h3>Nuevo usuario</h3>

    <div>
      <label>Username</label>
      <input id="alta-username" />
    </div>

    <div>
      <label>Nombre</label>
      <input id="alta-nombre" />
    </div>

    <div>
      <label>Apellido</label>
      <input id="alta-apellido" />
    </div>

    <div>
      <label>Email</label>
      <input id="alta-email" />
    </div>

    <div>
      <label>Password</label>
      <input id="alta-password" type="password" />
    </div>

    <button onclick="crearUsuario()">Crear</button>
    <button onclick="toggleFormularioAlta()">Cancelar</button>
  </div>

  <script>
    const API_USUARIOS_BASE = "/api/v0/usuarios";

    // =================================================================
    // FUNCIONES CRUD
    // =================================================================

    async function cargarUsuarios() {
      try {
        const res = await fetch(API_USUARIOS_BASE);
        if (!res.ok) throw new Error(`Error ${res.status} al cargar usuarios.`);

        const data = await res.json();
        const tbody = document.querySelector("#tabla-usuarios tbody");
        tbody.innerHTML = "";

        data.forEach(usuario => {
          const tr = document.createElement("tr");
          // Añadimos el ID como data-id para facilitar la selección
          tr.dataset.id = usuario.id_usuario;

          tr.innerHTML = `
            <td data-field="id_usuario" class="uneditable">${usuario.id_usuario}</td>
            <td data-field="username" class="uneditable">${usuario.username}</td>
            <td data-field="nombre_usuario" class="editable">${usuario.nombre_usuario ?? ''}</td>
            <td data-field="apellido" class="editable">${usuario.apellido ?? ''}</td>
            <td data-field="email" class="editable">${usuario.email ?? ''}</td>
            <td class="acciones">
              <button onclick="editarUsuario('${usuario.id_usuario}', this)">Editar</button>
              <button onclick="eliminarRegistro('${usuario.id_usuario}')">Eliminar</button>
            </td>
          `;
          tbody.appendChild(tr);
        });

      } catch (e) {
        console.error("Error al cargar:", e);
        alert("No se pudo cargar la lista de usuarios.");
      }
    }

    async function crearUsuario() {
      const body = {
        username: document.getElementById("alta-username").value,
        nombre_usuario: document.getElementById("alta-nombre").value,
        apellido: document.getElementById("alta-apellido").value,
        email: document.getElementById("alta-email").value,
        password: document.getElementById("alta-password").value
      };

      try {
        const res = await fetch(API_USUARIOS_BASE, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(body)
        });

        if (!res.ok) {
          const errorText = await res.text();
          throw new Error(`Error ${res.status}: ${errorText || res.statusText}`);
        }

        // Éxito: limpia y recarga
        document.getElementById("form-alta").querySelectorAll('input').forEach(input => input.value = '');
        toggleFormularioAlta();
        cargarUsuarios();

      } catch (error) {
        alert("Fallo al crear usuario: " + error.message);
        console.error("Error completo:", error);
      }
    }

    async function eliminarRegistro(idUsuario) {
      if (!confirm(`¿Eliminar usuario con ID ${idUsuario}?`)) return;

      try {
        const url = `${API_USUARIOS_BASE}/${idUsuario}`;
        const res = await fetch(url, { method: "DELETE" });

        if (!res.ok) {
          const errorText = await res.text();
          throw new Error(`Error ${res.status}: ${errorText || res.statusText}`);
        }

        cargarUsuarios();

      } catch (error) {
        alert("Fallo al eliminar: " + error.message);
        console.error("Error al eliminar:", error);
      }
    }

    // =================================================================
    // FUNCIONES DE EDICIÓN
    // =================================================================

    function editarUsuario(idUsuario, editButton) {
      const row = editButton.closest('tr');
      const editableFields = ['nombre_usuario', 'apellido', 'email'];

      // 1. Convertir celdas a inputs
      row.querySelectorAll('td').forEach(td => {
        const fieldName = td.dataset.field;

        if (editableFields.includes(fieldName)) {
          // Campos editables (Nombre, Apellido, Email)
          const currentValue = td.textContent;
          td.innerHTML = `<input type="text" value="${currentValue}" data-field="${fieldName}" class="editable">`;
        } else if (fieldName) {
          // Campos no editables (ID, Username) - Se simula la deshabilitación visual
          td.innerHTML = `<input type="text" value="${td.textContent}" disabled>`;
        }
      });

      // 2. Modificar botones
      const actionsCell = row.querySelector('.acciones');
      actionsCell.innerHTML = `
        <button onclick="guardarEdicion('${idUsuario}', this)">Guardar</button>
        <button onclick="cargarUsuarios()">Deshacer</button>
      `;
    }

    async function guardarEdicion(idUsuario, saveButton) {
      const row = saveButton.closest('tr');
      const inputs = row.querySelectorAll('input.editable');

      const body = {};
      inputs.forEach(input => {
        // Recopila los datos de los inputs
        body[input.dataset.field] = input.value;
      });

      try {
        // Ruta: /api/v0/usuarios/:id_usuario
        const url = `${API_USUARIOS_BASE}/${idUsuario}`;
        const res = await fetch(url, {
          method: "PUT", // Usamos PUT para la actualización
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(body)
        });

        if (!res.ok) {
          const errorText = await res.text();
          throw new Error(`Error ${res.status}: ${errorText || res.statusText}`);
        }

        alert("Usuario actualizado con éxito.");
        cargarUsuarios(); // Recargar para mostrar los datos actualizados y el estado normal

      } catch (error) {
        alert("Fallo al guardar: " + error.message);
        console.error("Error al guardar:", error);
      }
    }

    // =================================================================
    // FUNCIÓN DE UI
    // =================================================================

    function toggleFormularioAlta() {
      const f = document.getElementById("form-alta");
      const btn = document.getElementById("btn-toggle-form");

      if (f.style.display === "none" || f.style.display === "") {
        f.style.display = "block";
        btn.textContent = "Ocultar formulario";
      } else {
        f.style.display = "none";
        btn.textContent = "Agregar usuario";
      }
    }
  </script>

</body>
</html>