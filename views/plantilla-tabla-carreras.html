
<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>carreras</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 30px; background-color: #f9f9f9; }
    table { border-collapse: collapse; width: 100%; background: white; box-shadow: 0px 2px 6px rgba(0,0,0,0.1); }
    th, td { border: 1px solid #ddd; padding: 10px 12px; text-align: left; }
    th { background-color: #4CAF50; color: white; }
    tr:nth-child(even) { background-color: #f2f2f2; }
    tr:hover { background-color: #e1f5fe; }
    input { width: 100%; box-sizing: border-box; padding: 6px; }
    button { padding: 6px 10px; }
  </style>
</head>
<body onload="cargarTabla()">
  <h2>carreras</h2>
  <table id="tabla-generica">
    <thead>
      <tr id="thead-row"></tr>
    </thead>
    <tbody></tbody>
  </table>

  <script>
    const tableDef = {"name":"carreras","columns":[{"name":"id","type":"int","title":"id","description":""},{"name":"nombre_carrera","type":"text","title":"nombre_carrera","description":""}],"pk":["id"],"fks":[],"orderBy":["nombre_carrera"],"elementName":"carrera","title":"carreras"};
    const displayColumns = [{"field":"id","title":"id","editField":"id"},{"field":"nombre_carrera","title":"nombre_carrera","editField":"nombre_carrera"}];
    const pkValueFields = ["id"];
    const API_BASE = "/api/v0/" + tableDef.name;

    // solo puede haber una fila en edición a la vez
    let editandoPk = null;

    function buildPkPath(row) {
      return pkValueFields
        .map(function (f) { return encodeURIComponent(row[f]); })
        .join("/");
    }

    async function cargarTabla() {
      try {
        const resp_rol = await fetch('/api/v0/roles/get');
        if (!resp_rol.ok) return;

        const data_rol = await resp_rol.json();

        let urlApi = API_BASE;

        // Si es alumno, filtrar por su LU
        if(data_rol.nombreRol === "alumno"){

          const paramsURL = new URLSearchParams(window.location.search);
          const luAlumno = paramsURL.get('lu');

          if (luAlumno) {
              urlApi += "?lu=" + encodeURIComponent(luAlumno);
          }
        }

        // Si es profesor, filtrar por su legajo
        if(data_rol.nombreRol === "profesor"){

          const paramsURL = new URLSearchParams(window.location.search);
          const legajo = paramsURL.get('legajo');

          if (legajo) {
              urlApi += "?legajo=" + encodeURIComponent(legajo);
          }
        }

        const res = await fetch(urlApi, { headers: { "Content-Type": "application/json" }});

        if (!res.ok) {
          console.error("Error al cargar:", res.status);
          return;
        }

        const data = await res.json();
        const theadRow = document.getElementById("thead-row");
        const tbody = document.querySelector("#tabla-generica tbody");

        // Encabezados
        theadRow.innerHTML = "";
        displayColumns.forEach(function (col) {
          const th = document.createElement("th");
          th.textContent = col.title;
          theadRow.appendChild(th);
        });
        const thAcc = document.createElement("th");
        thAcc.textContent = "Acción";
        theadRow.appendChild(thAcc);

        // Filas
        tbody.innerHTML = "";
        data.forEach(function (row) {
          const tr = document.createElement("tr");
          const pkPath = buildPkPath(row);
          tr.dataset.pk = pkPath;

          // ⬅️ Guardamos la fila original completa
          tr.dataset.row = JSON.stringify(row);

          displayColumns.forEach(function (col) {
            const td = document.createElement("td");
            td.textContent = row[col.field] ?? "";
            tr.appendChild(td);
          });

          const tdAcc = document.createElement("td");
          const btnEdit = document.createElement("button");
          btnEdit.textContent = "Editar";
          btnEdit.onclick = function () { editar(pkPath); };
          tdAcc.appendChild(btnEdit);

          const btnDel = document.createElement("button");
          btnDel.textContent = "Eliminar";
          btnDel.onclick = function () { eliminarRegistro(pkPath); };
          tdAcc.appendChild(btnDel);

          tr.appendChild(tdAcc);
          tbody.appendChild(tr);
        });

        agregarFilaAlta(tbody);
      } catch (e) {
        console.error("Fallo al cargar tabla:", e);
      }
    }

    function agregarFilaAlta(tbody) {
      const tr = document.createElement("tr");

      tableDef.columns.forEach(function (col) {
        const td = document.createElement("td");
        const input = document.createElement("input");
        input.id = "new-" + col.name;
        input.placeholder = col.title || col.name;
        td.appendChild(input);
        tr.appendChild(td);
      });

      const tdAcc = document.createElement("td");
      const btn = document.createElement("button");
      btn.textContent = "Agregar";
      btn.onclick = crearRegistro;
      tdAcc.appendChild(btn);
      tr.appendChild(tdAcc);

      tbody.appendChild(tr);
    }

    async function crearRegistro() {
      const body = {};
      tableDef.columns.forEach(function (col) {
        const el = document.getElementById("new-" + col.name);
        body[col.name] = el.value || null;
      });
      const res = await fetch(API_BASE, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(body)
      });
      if (!res.ok) { alert("Error al crear: " + res.status); return; }
      cargarTabla();
    }

    async function eliminarRegistro(pkPath) {
      if (!confirm("¿Eliminar registro?")) return;
      const res = await fetch(API_BASE + "/" + pkPath, { method: "DELETE" });
      if (!res.ok) { alert("Error al eliminar: " + res.status); return; }
      cargarTabla();
    }




    async function confirmarEditar(pkPath) {
      const fila = document.querySelector('tr[data-pk="' + pkPath + '"]');

      // leer PK desde la URL
      const pkParts = pkPath.split("/").map(decodeURIComponent);

      // armamos body SOLO con las columnas reales del tableDef
      const body = {};

      // 1) Las PK siempre se preservan
      tableDef.pk.forEach(function (pkCol, idx) {
        body[pkCol] = pkParts[idx];
      });

      // 2) Para el resto de columnas reales, si tienen input usamos el valor, sino dejamos el original del rowData
      let rowData = {};
      if (fila && fila.dataset.row) {
        try { rowData = JSON.parse(fila.dataset.row); } catch {}
      }

      tableDef.columns.forEach(function (col) {
        const input = document.getElementById("edit-" + col.name);

        if (input) {
          // EDITABLE
          let val = input.value.trim();
          if (val === "") val = null;
          body[col.name] = val;
        } else {
          // NO EDITABLE → tomamos valor original REAL
          body[col.name] = rowData[col.name];
        }
      });

      // 3) Enviar PUT limpio
      try {
        const res = await fetch(API_BASE + "/" + pkPath, {
          method: "PUT",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(body)
        });
        if (!res.ok) throw new Error("Error al actualizar: " + res.status);

        editandoPk = null;
        cargarTabla();
      } catch (e) {
        alert("No se pudo actualizar: " + e.message);
      }
    }


    function cancelarEditar() {
      editandoPk = null;
      cargarTabla();
    }
  </script>

  </body>
  </html>