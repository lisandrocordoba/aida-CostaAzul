<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>AIDA - Cambiar Contrase침a</title>

<style>
  @import url('https://fonts.googleapis.com/css2?family=Roboto:wght@400;500&family=Merriweather:wght@700&display=swap');

  body {
    font-family: 'Roboto', sans-serif;
    margin: 0;
    background: #f4f6f8;
    color: #333;
  }

  /* ========== HEADER ========== */
  header {
    background: #2E7D32;
    color: white;
    padding: 28px 20px;
    text-align: center;
    position: relative;
    box-shadow: 0 3px 6px rgba(0,0,0,0.1);
  }

  header h1 {
    font-family: 'Merriweather', serif;
    margin: 0;
    font-size: 2.4em;
  }

  #datos-usuario {
    position: absolute;
    top: 8px;
    left: 45px;
    font-size: 0.95em;
    opacity: 0.95;
    font-weight: 700;
  }

  /* ICONO CAMBIO PASS */
  #password-left {
    position: absolute;
    top: 6px;
    left: 10px;
  }

  .password-icon {
    width: 26px;
    height: 26px;
    cursor: pointer;
    opacity: 0.9;
    transition: transform 0.2s, opacity 0.2s;
  }

  .password-icon:hover {
    transform: scale(1.12);
    opacity: 1;
  }

  #header-right {
    position: absolute;
    top: 18px;
    right: 20px;
    display: flex;
    gap: 14px;
    align-items: center;
  }

  #role-selector {
    background: white;
    color: #2E7D32;
    border: none;
    padding: 8px 10px;
    border-radius: 6px;
    font-size: 0.95em;
    cursor: pointer;
    box-shadow: 0 2px 5px rgba(0,0,0,0.15);
    opacity: 0;
    transition: opacity .2s;
  }

  #logoutForm button {
    background: #66BB6A;
    color: white;
    border: none;
    padding: 10px 16px;
    border-radius: 8px;
    cursor: pointer;
    font-size: 0.95em;
    font-weight: 500;
    box-shadow: 0 2px 6px rgba(0,0,0,0.15);
  }

  #logoutForm button:hover {
    background: #81C784;
  }

  /* ========== MAIN CONTENT ========== */
  main {
    max-width: 600px;
    margin: 40px auto;
    padding: 0 20px;
    opacity: 0;
    transition: opacity .2s;
  }

  h2 {
    color: #2E7D32;
    font-family: 'Merriweather', serif;
    text-align: center;
    margin-bottom: 25px;
  }

  .form-group {
    margin-bottom: 20px;
  }

  .form-group label {
    display: block;
    color: #2b4f2b;
    font-weight: 500;
    margin-bottom: 8px;
    font-size: 14px;
  }

  .form-group input {
    width: 100%;
    padding: 12px 16px;
    border: 2px solid #e7efe7;
    border-radius: 8px;
    font-size: 14px;
    transition: border-color 0.3s;
  }

  .form-group input:focus {
    outline: none;
    border-color: #2E7D32;
  }

  .btn-login {
    width: 100%;
    padding: 14px;
    background: linear-gradient(135deg, #2E7D32 0%, #256b28 100%);
    color: white;
    border: none;
    border-radius: 8px;
    font-size: 16px;
    font-weight: 600;
    cursor: pointer;
    transition: transform 0.2s, box-shadow 0.2s;
    margin-top: 10px;
  }

  .btn-login:hover {
    transform: translateY(-2px);
    box-shadow: 0 10px 20px rgba(46,125,50,0.35);
  }

  .error-message {
    background: #fff6f6;
    color: #b22222;
    padding: 12px;
    border-radius: 8px;
    margin-bottom: 20px;
    font-size: 14px;
    display: none;
  }

  .error-message.show {
    display: block;
  }

  .success-message {
    background: #e8f8ee;
    color: #1b5e20;
    padding: 12px;
    border-radius: 8px;
    margin-bottom: 20px;
    font-size: 14px;
    border: 1px solid #c8e6c9;
    display: none;
  }

  .success-message.show {
    display: block;
  }

  footer {
    text-align: center;
    margin: 80px 0 20px;
    color: #777;
    font-size: 0.9em;
  }
</style>


<script>
  async function buildMenu() {
    try {
      const resp = await fetch("/api/v0/roles/get", { credentials: "include" });
      if (!resp.ok) throw new Error("No se pudo obtener rol");

      const { nombreRol, nombre, apellido } = await resp.json();

      document.getElementById("datos-usuario").innerText =
        `${apellido}, ${nombre} (${nombreRol})`;

      const selector = document.getElementById("role-selector");
      selector.value = nombreRol;
      selector.style.opacity = "1";

      document.querySelector("main").style.opacity = "1";

    } catch (err) {
      console.error("Error al cargar men칰:", err);
      document.querySelector("main").style.opacity = "1";
    }
  }

  async function cambiarRol(rol) {
    try {
      await fetch("/api/v0/roles/select", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        credentials: "include",
        body: JSON.stringify({ rol })
      });
    } catch (e) {
      console.error("Error cambiando rol:", e);
    }
    window.location.reload();
  }

  window.onload = buildMenu;
</script>

</head>
<body>

<header>

  <!-- ICONO DE CAMBIO DE PASSWORD A LA IZQUIERDA -->
  <a id="password-left" href="/app/cambiar-passwords" title="Cambiar contrase침a">
    <svg class="password-icon" viewBox="0 0 24 24" fill="#FFD54F">
      <path d="M12 17a2 2 0 1 0 0-4 2 2 0 0 0 0 4Zm6-7h-1V7a5 5 0 0 0-10 0v3H6a2 2 0 0 0-2 2v8a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2v-8a2 2 0 0 0-2-2ZM9 7a3 3 0 0 1 6 0v3H9V7Z"/>
    </svg>
  </a>

  <div id="datos-usuario">Cargando...</div>

  <h1>AIDA</h1>

  <div id="header-right">
    <select id="role-selector" onchange="cambiarRol(this.value)">
      <option value="alumno">Alumno</option>
      <option value="profesor">Profesor</option>
      <option value="secretario">Secretario</option>
    </select>

    <form id="logoutForm" action="/api/v0/auth/logout" method="POST">
      <button type="submit">Cerrar sesi칩n</button>
    </form>
  </div>
</header>


<main>
  <h2>游댏 Cambiar Contrase침a</h2>

  <div id="successMessage" class="success-message"></div>
  <div id="errorMessage" class="error-message"></div>

  <form id="passwordForm">

    <div class="form-group">
      <label for="password">Nueva contrase침a</label>
      <input type="password" id="password" name="password" placeholder="Ingrese la nueva contrase침a" required>
    </div>

    <button type="submit" class="btn-login">Actualizar</button>
  </form>
</main>


<footer>
  &copy; 2025 AIDA - Universidad
</footer>


<script>
  const form = document.getElementById('passwordForm');
  const errorMessage = document.getElementById('errorMessage');
  const successMessage = document.getElementById('successMessage');

  form.addEventListener('submit', async (e) => {
    e.preventDefault();

    const password = document.getElementById('password').value;

    errorMessage.classList.remove('show');
    successMessage.classList.remove('show');

    try {
      const resp = await fetch('/api/v0/auth/cambiar-passwords', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ password })
      });

      const data = await resp.json();

      if (resp.ok) {
        successMessage.textContent = 'Contrase침a actualizada correctamente 九덢잺';
        successMessage.classList.add('show');
        form.reset();
      } else {
        errorMessage.textContent = data.error || 'Error al cambiar contrase침a';
        errorMessage.classList.add('show');
      }
    } catch (err) {
      errorMessage.textContent = 'Error de conexi칩n con el servidor';
      errorMessage.classList.add('show');
    }
  });

  document.getElementById('password').addEventListener('input', () => {
    errorMessage.classList.remove('show');
    successMessage.classList.remove('show');
  });
</script>

</body>
</html>
