<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Listado de Alumnos</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 30px; background-color: #f9f9f9; }
    table { border-collapse: collapse; width: 100%; background: white; box-shadow: 0px 2px 6px rgba(0,0,0,0.1); }
    th, td { border: 1px solid #ddd; padding: 10px 12px; text-align: left; }
    th { background-color: #4CAF50; color: white; }
    tr:nth-child(even) { background-color: #f2f2f2; }
    tr:hover { background-color: #e1f5fe; }
    input { width: 100%; box-sizing: border-box; padding: 6px; }
    button { padding: 6px 10px; }
  </style>
</head>
<body onload="cargarAlumnos()">
  <h2>Listado de Alumnos</h2>
  <table id="tabla-alumnos">
    <thead>
      <tr>
        <th>LU</th>
        <th>Apellido</th>
        <th>Nombres</th>
        <th>Título</th>
        <th>Título en trámite</th>
        <th>Egreso</th>
        <th>Acción</th>
      </tr>
    </thead>
    <tbody>
      <!-- Filas dinámicas + última fila para agregar -->
    </tbody>
  </table>

  <script>
    let editandoLU = null; // asegura una sola fila en edición

    async function cargarAlumnos() {
      try {
        const response = await fetch("/app/tablaAlumnos", {
          method: "GET",
          headers: { "Content-Type": "application/json" },
        });
        if (!response.ok) throw new Error("Error en la petición: " + response.status);

        const alumnos = await response.json();
        const tbody = document.querySelector("#tabla-alumnos tbody");
        tbody.innerHTML = "";

        alumnos.forEach(alumno => {
          const fila = document.createElement("tr");
          fila.dataset.lu = alumno.lu;
          fila.innerHTML = `
            <td>${alumno.lu}</td>
            <td>${alumno.apellido || ""}</td>
            <td>${alumno.nombres || ""}</td>
            <td>${alumno.titulo || ""}</td>
            <td>${alumno.titulo_en_tramite || "-"}</td>
            <td>${alumno.egreso || ""}</td>
            <td>
              <button onclick="empezarEditar('${alumno.lu}')" ${editandoLU ? "disabled" : ""}>Editar</button>
              <button onclick="borrarAlumno('${alumno.lu}')" ${editandoLU ? "disabled" : ""}>Eliminar</button>
            </td>
          `;
          tbody.appendChild(fila);
        });

        agregarFilaDeAlta(tbody);

      } catch (error) {
        console.error("No se pudo cargar la lista de alumnos:", error);
      }
    }

    function agregarFilaDeAlta(tbody) {
      const filaAlta = document.createElement("tr");
      filaAlta.id = "fila-alta";
      filaAlta.innerHTML = `
        <td><input id="new-lu" placeholder="1600/17" /></td>
        <td><input id="new-apellido" placeholder="Apellido" /></td>
        <td><input id="new-nombres" placeholder="Nombres" /></td>
        <td><input id="new-titulo" placeholder="Título" /></td>
        <td><input id="new-tramite" type="date" placeholder="YYYY-MM-DD" /></td>
        <td><input id="new-egreso" type="date" placeholder="YYYY-MM-DD" /></td>
        <td><button onclick="crearAlumno()" ${editandoLU ? "disabled" : ""}>Agregar</button></td>
      `;
      tbody.appendChild(filaAlta);
    }

    async function crearAlumno() {
      const lu = document.getElementById("new-lu").value.trim();
      const apellido = document.getElementById("new-apellido").value.trim();
      const nombres = document.getElementById("new-nombres").value.trim();
      const titulo = document.getElementById("new-titulo").value.trim();
      const titulo_en_tramite = document.getElementById("new-tramite").value || null;
      const egreso = document.getElementById("new-egreso").value || null;

      if (!lu) return alert("LU es obligatorio");

      const alumno = { lu, apellido, nombres, titulo, titulo_en_tramite, egreso };

      try {
        const res = await fetch("/app/tablaAlumnos", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(alumno)
        });
        if (!res.ok) throw new Error("Error al crear: " + res.status);
        await cargarAlumnos();
      } catch (e) {
        alert("No se pudo agregar el alumno: " + e.message);
      }
    }

    function empezarEditar(lu) {
      if (editandoLU) return; // ya hay una fila en edición
      editandoLU = lu;

      const fila = document.querySelector(`tr[data-lu="${CSS.escape(lu)}"]`);
      if (!fila) return;

      const [cLU, cApe, cNom, cTit, cTram, cEgre, cAcc] = fila.querySelectorAll("td");
      const val = {
        lu: cLU.textContent.trim(),
        apellido: cApe.textContent.trim(),
        nombres: cNom.textContent.trim(),
        titulo: cTit.textContent.trim(),
        titulo_en_tramite: cTram.textContent.trim() === "-" ? "" : cTram.textContent.trim(),
        egreso: cEgre.textContent.trim()
      };

      // Reemplazar por inputs (LU queda fijo)
      cLU.innerHTML = `<input value="${escapeAttr(val.lu)}" disabled />`;
      cApe.innerHTML = `<input id="edit-apellido" value="${escapeAttr(val.apellido)}" />`;
      cNom.innerHTML = `<input id="edit-nombres" value="${escapeAttr(val.nombres)}" />`;
      cTit.innerHTML = `<input id="edit-titulo" value="${escapeAttr(val.titulo)}" />`;
      cTram.innerHTML = `<input id="edit-tramite" type="date" value="${toInputDate(val.titulo_en_tramite)}" />`;
      cEgre.innerHTML = `<input id="edit-egreso" type="date" value="${toInputDate(val.egreso)}" />`;
      cAcc.innerHTML = `
        <button onclick="confirmarEditar('${val.lu}')">Confirmar</button>
        <button onclick="cancelarEditar('${val.lu}', '${escapeAttr(val.apellido)}', '${escapeAttr(val.nombres)}', '${escapeAttr(val.titulo)}', '${escapeAttr(val.titulo_en_tramite)}', '${escapeAttr(val.egreso)}')">Cancelar</button>
      `;

      // Deshabilitar otros botones (opcional: ya controlamos con editandoLU en render)
      document.querySelectorAll('#tabla-alumnos tbody tr button').forEach(b=>{
        if (!cAcc.contains(b)) b.disabled = true;
      });
    }

    async function confirmarEditar(lu) {
      const fila = document.querySelector(`tr[data-lu="${CSS.escape(lu)}"]`);
      if (!fila) return;

      const apellido = document.getElementById("edit-apellido").value.trim();
      const nombres = document.getElementById("edit-nombres").value.trim();
      const titulo = document.getElementById("edit-titulo").value.trim();
      const titulo_en_tramite = document.getElementById("edit-tramite").value || null;
      const egreso = document.getElementById("edit-egreso").value || null;

      const alumno = { lu, apellido, nombres, titulo, titulo_en_tramite, egreso };

      try {
        const res = await fetch(`/app/tablaAlumnos/${encodeURIComponent(lu)}`, {
          method: "PUT",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(alumno)
        });
        if (!res.ok) throw new Error("Error al actualizar: " + res.status);
        editandoLU = null;
        await cargarAlumnos();
      } catch (e) {
        alert("No se pudo actualizar: " + e.message);
      }
    }

    function cancelarEditar(lu, apellido, nombres, titulo, tramite, egreso) {
      const fila = document.querySelector(`tr[data-lu="${CSS.escape(lu)}"]`);
      if (!fila) return;

      const celdas = fila.querySelectorAll("td");
      celdas[0].innerHTML = `${lu}`;
      celdas[1].innerHTML = `${unescapeAttr(apellido)}`;
      celdas[2].innerHTML = `${unescapeAttr(nombres)}`;
      celdas[3].innerHTML = `${unescapeAttr(titulo)}`;
      celdas[4].innerHTML = `${(unescapeAttr(tramite) || "-")}`;
      celdas[5].innerHTML = `${unescapeAttr(egreso)}`;
      celdas[6].innerHTML = `
        <button onclick="empezarEditar('${lu}')">Editar</button>
        <button onclick="borrarAlumno('${lu}')">Eliminar</button>
      `;

      // Rehabilitar botones globales
      document.querySelectorAll('#tabla-alumnos tbody tr button').forEach(b=> b.disabled = false);
      editandoLU = null;
    }

    async function borrarAlumno(lu) {
      if (!confirm("¿Eliminar alumno con LU " + lu + "?")) return;
      try {
        const res = await fetch(`/app/tablaAlumnos/${encodeURIComponent(lu)}`, { method: "DELETE" });
        if (!res.ok) throw new Error("Error al eliminar: " + res.status);
        await cargarAlumnos();
      } catch (e) {
        alert("No se pudo eliminar: " + e.message);
      }
    }

    // Helpers
    function toInputDate(s) {
      if (!s) return "";
      const d = new Date(s);
      if (isNaN(d.getTime())) return "";
      const y = d.getFullYear();
      const m = String(d.getMonth()+1).padStart(2, "0");
      const dd = String(d.getDate()).padStart(2, "0");
      return `${y}-${m}-${dd}`;
    }
    function escapeAttr(s){ return String(s).replace(/["'&<>]/g, m => ({'"':'&quot;',"'":"&#39;","&":"&amp;","<":"&lt;",">":"&gt;"}[m])); }
    function unescapeAttr(s){ const p = {"&quot;":'"',"&#39;":"'", "&amp;":"&", "&lt;":"<", "&gt;":">"}; return String(s).replace(/(&quot;|&#39;|&amp;|&lt;|&gt;)/g, m=>p[m]); }
  </script>
</body>
</html>
